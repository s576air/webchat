<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chatroom</title>
    <script>
        const chatroomId = [[${id}]];
        const mediaSrc = '/media/' + chatroomId + '/';
        const uploadUrl = '/upload/' + chatroomId;
        let firstChatId = 2147483647;
        const socket = new WebSocket('/ws/chat');

        function createTextMessageDiv(message) {
            const outerDiv = document.createElement('div');

            const chat = document.createElement('div');
            chat.classList.add('chat');
            chat.textContent = message.content;

            const chatInfo = document.createElement('div');
            chatInfo.classList.add('chat-info');
            chatInfo.textContent = '유저id: ' + message.userId + ', 시간: ' +  message.sentTime;

            outerDiv.appendChild(chat);
            outerDiv.appendChild(chatInfo);

            return outerDiv;
        }

        function uploadFile(file) {
            if (!file.length) { return; }

            const formData = new FormData();
            formData.append('file', file);

            fetch(uploadUrl, {
                method: 'POST',
                body: formData
            })
            .catch(error => alert('업로드 실패: ' + error));
        }

        socket.onopen = () => {
            console.log("WebSocket 연결됨!");
        };

        socket.onmessage = function(event) {
            console.log(event.data);
            const data = JSON.parse(event.data);

            if (data.tag == "error") {
                console.log(data.content);
            } else if (data.tag == "newChat") {
                const message = data.content;
                const chatsDiv = document.getElementById('chats');

                const outerDiv = document.createElement('div');

                const chat = document.createElement('div');
                chat.classList.add('chat');
                chat.textContent = message.content;

                const chatInfo = document.createElement('div');
                chatInfo.classList.add('chat-info');
                chatInfo.textContent = '유저id: ' + message.userId + ', 시간: ' +  message.sentTime;

                outerDiv.appendChild(chat);
                outerDiv.appendChild(chatInfo);

                chatsDiv.appendChild(outerDiv);
            } else if (data.tag == "chats") {
                const messages = data.content;
                const chatsDiv = document.getElementById('chats');

                if (messages.length != 0) {
                    firstChatId = messages[messages.length-1].id;
                }

                for(let i = 0; i < messages.length; i++) {
                    const message = messages[i];
                    let element;

                    if (message.type == "") {
                        element = createTextMessageDiv(message);
                    } else if (message.type.startsWith('image')) {
                        element = document.createElement("div");

                        const image = document.createElement("img");
                        image.src = mediaSrc + message.id;
                        image.alt = "이미지";

                        element.appendChild(image);
                    } else if (message.type.startsWith('audio')) {
                        const audio = document.createElement("audio");
                        audio.controls = true;

                        const source = document.createElement("source");
                        source.src = mediaSrc + message.id;
                        source.type = "audio/" + message.type;

                        audio.appendChild(source);

                        element = audio;
                    } else if (message.type.startsWith('video')) {
                        const video = document.createElement("video");
                        video.controls = true;

                        const source = document.createElement("source");
                        source.src = mediaSrc + message.id;
                        source.type = "video/" + message.type;

                        video.appendChild(source);

                        element = video;
                    }


                    chatsDiv.prepend(element);
                }
            }


        }

        socket.onclose = () => {
            console.log("WebSocket 연결 종료됨");
        };

        socket.onerror = (error) => {
            console.error("WebSocket 오류:", error);
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('load').addEventListener('click', () => {

                const loadRequest = {
                    type: "load",
                    chatroomId: chatroomId,
                    text: String(firstChatId)
                };
                socket.send(JSON.stringify(loadRequest));
            });

            document.getElementById('send').addEventListener('click', () => {
                const userInputDiv = document.getElementById('userInput');
                const userInput = userInputDiv.value;
                userInputDiv.value = '';

                if (userInput) {
                    const message = {
                        type: "send",
                        chatroomId: chatroomId,
                        text: userInput
                    };
                    socket.send(JSON.stringify(message));
                }
            });

            const dropZone = document.getElementById('drop-zone');

            dropZone.addEventListener('dragover', (event) => {
                event.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (event) => {
                event.preventDefault();
                dropZone.classList.remove('dragover');

                uploadFile(event.dataTransfer.files);
            });
        });
    </script>
    <style>
        .chat {
            font-size: 18px;
        }
        .chat-info {
            font-size: 12px;
        }
        #dropZone {
            width: 200px;
            height: 200px;
            border: 2px dashed #aaa;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #aaa;
            margin: 10px;
        }
        #drop-zone.dragover {
            border-color: #333;
            color: #333;
        }
    </style>
</head>
<body>

<button type="button" id="load">이전 메시지 가져오기</button>

<div id="chats"><div>
</div></div>

<label for="userInput">메시지:</label>
<input type="text" id="userInput" placeholder="메시지 입력">
<button type="button" id="send">전송</button>

<div id="dropZone">파일 업로드</div>

<button onclick="uploadFiles()">파일 업로드</button>

<p th:text="'챗방 id: ' + ${id}"></p>
</body>
</html>